<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Kighmu â€” Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#030712;--surface:#0d1117;--card:#111827;--card2:#1a2235;--border:rgba(0,200,255,.12);--borderB:rgba(0,200,255,.35);--cyan:#00c8ff;--cyanD:rgba(0,200,255,.15);--purple:#7c3aed;--purpleD:rgba(124,58,237,.15);--green:#10b981;--greenD:rgba(16,185,129,.15);--red:#ef4444;--redD:rgba(239,68,68,.15);--yellow:#f59e0b;--yellowD:rgba(245,158,11,.15);--text:#e2e8f0;--dim:#94a3b8;--muted:#475569;--mono:'Share Tech Mono',monospace;--ui:'Rajdhani',sans-serif;--r:6px;--tr:.22s cubic-bezier(.4,0,.2,1)}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:var(--ui);font-size:15px;line-height:1.5;min-height:100vh;overflow-x:hidden}
.grid{position:fixed;inset:0;z-index:0;pointer-events:none;background-image:linear-gradient(rgba(0,200,255,.02) 1px,transparent 1px),linear-gradient(90deg,rgba(0,200,255,.02) 1px,transparent 1px);background-size:50px 50px}
/* LAYOUT */
.layout{display:flex;min-height:100vh;position:relative;z-index:1}
.sidebar{width:235px;min-height:100vh;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;z-index:100;transition:transform var(--tr)}
.s-logo{padding:1.25rem 1.5rem;border-bottom:1px solid var(--border)}
.s-logo .lt{font-family:var(--mono);font-size:1.15rem;letter-spacing:.25em;background:linear-gradient(135deg,var(--cyan),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-transform:uppercase}
.s-logo .ls{font-size:.62rem;color:var(--muted);letter-spacing:.3em;text-transform:uppercase;margin-top:2px}
.s-nav{flex:1;padding:.75rem 0;overflow-y:auto}
.s-sec{padding:.5rem 1rem .2rem;font-size:.62rem;letter-spacing:.3em;text-transform:uppercase;color:var(--muted)}
.nav{display:flex;align-items:center;gap:.65rem;padding:.6rem 1.2rem;cursor:pointer;color:var(--dim);font-size:.88rem;font-weight:500;transition:all var(--tr);border-left:2px solid transparent;text-decoration:none}
.nav:hover{color:var(--text);background:var(--cyanD)}
.nav.active{color:var(--cyan);background:var(--cyanD);border-left-color:var(--cyan)}
.nav .ic{width:18px;font-size:.95rem}
.s-foot{padding:.9rem 1.2rem;border-top:1px solid var(--border)}
.s-user{font-family:var(--mono);color:var(--cyan);font-size:.88rem;margin-bottom:.25rem}
.main{margin-left:235px;flex:1;display:flex;flex-direction:column;min-height:100vh}
.topbar{height:58px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 1.25rem;position:sticky;top:0;z-index:50}
.tb-title{font-family:var(--mono);font-size:.82rem;color:var(--dim);letter-spacing:.08em}
.tb-title span{color:var(--cyan)}
.tb-acts{display:flex;align-items:center;gap:.65rem}
/* PAGES */
.page{padding:1.25rem;display:none}
.page.active{display:block}
.ptitle{font-size:1.4rem;font-weight:700;margin-bottom:.2rem;letter-spacing:.04em}
.psub{color:var(--dim);font-size:.82rem;margin-bottom:1.25rem}
/* STATS */
.sgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(185px,1fr));gap:.875rem;margin-bottom:1.25rem}
.scard{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:1.1rem;position:relative;overflow:hidden;transition:border-color var(--tr)}
.scard::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--cyan),var(--purple));opacity:0;transition:opacity var(--tr)}
.scard:hover{border-color:var(--borderB)}.scard:hover::before{opacity:1}
.scard-lbl{font-size:.67rem;letter-spacing:.2em;text-transform:uppercase;color:var(--muted);margin-bottom:.4rem}
.scard-val{font-family:var(--mono);font-size:1.65rem}
.scard-ico{position:absolute;top:1rem;right:1rem;font-size:1.3rem;opacity:.28}
.scard.c .scard-val{color:var(--cyan)}.scard.g .scard-val{color:var(--green)}.scard.p .scard-val{color:#a78bfa}.scard.y .scard-val{color:var(--yellow)}
/* CARD */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);margin-bottom:1.25rem}
.ch{display:flex;align-items:center;justify-content:space-between;padding:.875rem 1.1rem;border-bottom:1px solid var(--border)}
.ct{font-size:.78rem;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--dim)}
.cb{padding:1.1rem}
/* TABLE */
.tw{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:.835rem}
thead th{text-align:left;padding:.55rem .9rem;font-size:.67rem;letter-spacing:.15em;text-transform:uppercase;color:var(--muted);border-bottom:1px solid var(--border);background:var(--surface);font-weight:600}
tbody tr{border-bottom:1px solid rgba(255,255,255,.03);transition:background var(--tr)}
tbody tr:hover{background:rgba(0,200,255,.03)}
tbody td{padding:.65rem .9rem;color:var(--dim);font-family:var(--mono);font-size:.8rem}
td.nm{color:var(--text);font-family:var(--ui);font-weight:600}
/* BADGE */
.b{display:inline-block;padding:.12rem .55rem;border-radius:100px;font-size:.67rem;font-weight:700;letter-spacing:.05em;text-transform:uppercase;font-family:var(--mono)}
.bg{background:var(--greenD);color:var(--green);border:1px solid rgba(16,185,129,.3)}
.br{background:var(--redD);color:var(--red);border:1px solid rgba(239,68,68,.3)}
.bc{background:var(--cyanD);color:var(--cyan);border:1px solid rgba(0,200,255,.3)}
.by{background:var(--yellowD);color:var(--yellow);border:1px solid rgba(245,158,11,.3)}
.bp{background:var(--purpleD);color:#a78bfa;border:1px solid rgba(124,58,237,.3)}
/* BTN */
.btn{display:inline-flex;align-items:center;gap:.45rem;padding:.48rem 1rem;border-radius:var(--r);font-family:var(--ui);font-size:.82rem;font-weight:600;cursor:pointer;border:1px solid transparent;transition:all var(--tr);white-space:nowrap}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-c{background:var(--cyanD);border-color:rgba(0,200,255,.4);color:var(--cyan)}.btn-c:hover:not(:disabled){background:var(--cyan);color:var(--bg)}
.btn-r{background:var(--redD);border-color:rgba(239,68,68,.4);color:var(--red)}.btn-r:hover:not(:disabled){background:var(--red);color:#fff}
.btn-g{background:var(--greenD);border-color:rgba(16,185,129,.4);color:var(--green)}.btn-g:hover:not(:disabled){background:var(--green);color:#fff}
.btn-p{background:var(--purpleD);border-color:rgba(124,58,237,.4);color:#a78bfa}.btn-p:hover:not(:disabled){background:var(--purple);color:#fff}
.btn-gh{background:transparent;border-color:var(--border);color:var(--dim)}.btn-gh:hover:not(:disabled){border-color:var(--borderB);color:var(--text)}
.btn-sm{padding:.28rem .65rem;font-size:.75rem}
.btn-ic{padding:.35rem}
/* FORM */
.fgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:.875rem}
.fg{display:flex;flex-direction:column;gap:.3rem}
.fl{font-size:.68rem;letter-spacing:.15em;text-transform:uppercase;color:var(--muted);font-weight:600}
.fc{background:var(--bg);border:1px solid var(--border);border-radius:var(--r);padding:.55rem .8rem;color:var(--text);font-family:var(--mono);font-size:.82rem;outline:none;transition:border-color var(--tr);width:100%}
.fc:focus{border-color:var(--cyan);box-shadow:0 0 0 2px rgba(0,200,255,.1)}
.fc::placeholder{color:var(--muted)}
select.fc option{background:var(--card)}
/* MODAL */
.mo{position:fixed;inset:0;z-index:1000;background:rgba(3,7,18,.82);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;padding:1rem}
.mo.open{display:flex}
.modal{background:var(--card);border:1px solid var(--borderB);border-radius:var(--r);width:100%;max-width:500px;box-shadow:0 0 60px rgba(0,200,255,.1);animation:mIn .22s ease}
@keyframes mIn{from{opacity:0;transform:translateY(-18px) scale(.97)}to{opacity:1;transform:none}}
.mh{display:flex;align-items:center;justify-content:space-between;padding:1.1rem 1.25rem;border-bottom:1px solid var(--border)}
.mt{font-size:.95rem;font-weight:700;letter-spacing:.04em}
.mb{padding:1.1rem 1.25rem}
.mf{display:flex;justify-content:flex-end;gap:.65rem;padding:.875rem 1.25rem;border-top:1px solid var(--border)}
/* PROGRESS */
.prg{height:5px;background:var(--bg);border-radius:3px;overflow:hidden}
.prg-b{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--cyan),var(--purple));transition:width .5s}
/* MONITOR */
.mgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1rem}
.mi{display:flex;flex-direction:column;gap:.4rem}
.ml{display:flex;justify-content:space-between;font-size:.78rem}
.mk{color:var(--dim);text-transform:uppercase;letter-spacing:.1em;font-size:.68rem}
.mv{color:var(--cyan);font-family:var(--mono)}
/* TOAST */
.tc{position:fixed;bottom:1.25rem;right:1.25rem;z-index:9999;display:flex;flex-direction:column;gap:.4rem}
.toast{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:.65rem .9rem;font-size:.8rem;min-width:230px;display:flex;align-items:center;gap:.45rem;animation:tIn .25s;box-shadow:0 4px 20px rgba(0,0,0,.4)}
@keyframes tIn{from{opacity:0;transform:translateX(16px)}to{opacity:1}}
.toast.s{border-left:3px solid var(--green)}.toast.e{border-left:3px solid var(--red)}.toast.i{border-left:3px solid var(--cyan)}
/* TUNNEL SELECTOR */
.tgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(145px,1fr));gap:.65rem;margin-bottom:.875rem}
.tc2{background:var(--surface);border:2px solid var(--border);border-radius:var(--r);padding:.9rem .65rem;cursor:pointer;text-align:center;transition:all var(--tr);user-select:none}
.tc2:hover{border-color:var(--borderB);background:rgba(0,200,255,.04)}
.tc2.sel{border-color:var(--cyan);background:var(--cyanD);box-shadow:0 0 14px rgba(0,200,255,.13)}
.tc2.ssh.sel{border-color:var(--green);background:var(--greenD)}
.tc2.udp.sel{border-color:var(--red);background:var(--redD)}
.tc2.v2.sel{border-color:#a78bfa;background:var(--purpleD)}
.tci{font-size:1.5rem;margin-bottom:.3rem;color:var(--muted)}
.tc2.sel .tci{color:var(--cyan)}.tc2.ssh.sel .tci{color:var(--green)}.tc2.udp.sel .tci{color:var(--red)}.tc2.v2.sel .tci{color:#a78bfa}
.tlb{font-size:.76rem;font-weight:700;letter-spacing:.05em;color:var(--dim)}
.tsb{font-size:.64rem;color:var(--muted);margin-top:2px}
/* RESULT */
.rescard{background:var(--surface);border:1px solid var(--borderB);border-radius:var(--r);margin-top:1.25rem;overflow:hidden;animation:mIn .25s;max-width:780px}
.rh{background:linear-gradient(90deg,rgba(0,200,255,.1),rgba(124,58,237,.1));padding:.65rem 1.1rem;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
.rt{color:var(--cyan);font-weight:700;font-size:.88rem}
.rbody{padding:1.1rem}
.rrow{display:flex;align-items:center;gap:.9rem;padding:.5rem 0;border-bottom:1px solid rgba(255,255,255,.04)}
.rrow:last-child{border:none}
.rk{font-size:.67rem;letter-spacing:.2em;text-transform:uppercase;color:var(--muted);min-width:90px}
.rv{font-family:var(--mono);font-size:.82rem;color:var(--text);word-break:break-all;flex:1}
.rv.hi{color:var(--cyan)}.rv.pw{color:var(--yellow)}.rv.uu{color:var(--dim);font-size:.76rem}
.cpbtn{padding:.18rem .5rem;font-size:.68rem;background:var(--card2);border:1px solid var(--border);border-radius:4px;color:var(--muted);cursor:pointer;transition:all var(--tr);white-space:nowrap}
.cpbtn:hover{border-color:var(--cyan);color:var(--cyan)}
/* INFOBANNER */
.ibanner{background:linear-gradient(90deg,rgba(0,200,255,.05),rgba(124,58,237,.05));border:1px solid var(--border);border-radius:var(--r);padding:.75rem 1.1rem;display:flex;gap:2.25rem;margin-bottom:1.1rem;flex-wrap:wrap}
.ibi{display:flex;flex-direction:column}
.ibk{font-size:.62rem;letter-spacing:.2em;text-transform:uppercase;color:var(--muted)}
.ibv{font-family:var(--mono);font-size:1rem;color:var(--cyan)}
/* SEARCH */
.sbox{position:relative;display:inline-flex;align-items:center}
.sbox input{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:.42rem .7rem .42rem 1.85rem;color:var(--text);font-size:.78rem;outline:none;transition:border-color var(--tr)}
.sbox input:focus{border-color:var(--cyan)}
.sbox::before{content:'âŒ•';position:absolute;left:.55rem;color:var(--muted);font-size:.95rem;pointer-events:none}
/* MISC */
.ssep{display:flex;align-items:center;gap:.875rem;margin:1.25rem 0 .875rem;color:var(--muted);font-size:.68rem;letter-spacing:.2em;text-transform:uppercase;font-weight:700}
.ssep::after{content:'';flex:1;height:1px;background:var(--border)}
.dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:5px}
.dg{background:var(--green);box-shadow:0 0 5px var(--green)}.dr{background:var(--red);box-shadow:0 0 5px var(--red)}
.actg{display:flex;gap:.3rem;flex-wrap:nowrap}
.spin{display:inline-block;width:13px;height:13px;border:2px solid var(--border);border-top-color:var(--cyan);border-radius:50%;animation:spin .65s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.flex{display:flex}.aic{align-items:center}.jb{justify-content:space-between}.g1{gap:.5rem}.g2{gap:.875rem}.mt1{margin-top:.5rem}.mono{font-family:var(--mono)}.muted{color:var(--muted)}.sm{font-size:.78rem}
/* LOGIN */
.lpage{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1rem;position:relative}
.lglow{position:fixed;width:500px;height:500px;border-radius:50%;background:radial-gradient(circle,rgba(0,150,255,.07),transparent 70%);top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none}
.lbox{background:var(--card);border:1px solid var(--borderB);border-radius:8px;padding:2.25rem;width:100%;max-width:390px;position:relative;z-index:1;box-shadow:0 0 60px rgba(0,200,255,.08)}
.llogo{font-family:var(--mono);font-size:1.4rem;letter-spacing:.3em;text-align:center;background:linear-gradient(135deg,var(--cyan),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:.4rem}
.lsub{text-align:center;color:var(--muted);font-size:.7rem;letter-spacing:.3em;text-transform:uppercase;margin-bottom:1.75rem}
.lsep{width:100%;height:1px;background:linear-gradient(90deg,transparent,var(--borderB),transparent);margin-bottom:1.75rem}
.lerr{background:var(--redD);border:1px solid rgba(239,68,68,.3);border-radius:var(--r);padding:.55rem .9rem;color:var(--red);font-size:.78rem;margin-bottom:.875rem;display:none}
.lbtn{width:100%;justify-content:center;padding:.7rem;font-size:.85rem;letter-spacing:.15em;text-transform:uppercase;background:linear-gradient(135deg,rgba(0,200,255,.18),rgba(124,58,237,.18));border:1px solid var(--borderB);color:var(--cyan);margin-top:1.25rem}
.lbtn:hover{background:linear-gradient(135deg,rgba(0,200,255,.35),rgba(124,58,237,.35));box-shadow:0 0 25px rgba(0,200,255,.2)}
/* RESPONSIVE */
.mbtn{display:none;background:none;border:none;color:var(--dim);font-size:1.1rem;cursor:pointer;padding:.2rem}
@media(max-width:768px){.sidebar{transform:translateX(-100%)}.sidebar.open{transform:none}.main{margin-left:0}.mbtn{display:block}.sgrid{grid-template-columns:1fr 1fr}.fgrid{grid-template-columns:1fr}.tgrid{grid-template-columns:repeat(3,1fr)}}
.hidden{display:none!important}
</style>
</head>
<body>
<div class="grid"></div>

<!-- LOGIN -->
<div id="LS">
  <div class="lpage">
    <div class="lglow"></div>
    <div class="lbox">
      <div class="llogo">KIGHMU</div>
      <div class="lsub">AccÃ¨s Administrateur</div>
      <div class="lsep"></div>
      <div style="text-align:center;margin-bottom:1.25rem"><span class="b bc">ADMINISTRATOR</span></div>
      <div class="lerr" id="lerr"></div>
      <div class="fg"><label class="fl">Identifiant</label><input class="fc" id="lu" placeholder="admin" autocomplete="username"></div>
      <div class="fg mt1"><label class="fl">Mot de passe</label><input class="fc" type="password" id="lp" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"></div>
      <button class="btn lbtn" id="lbtn" onclick="doLogin()"><span id="lbl">SE CONNECTER</span></button>
    </div>
  </div>
</div>

<!-- PANEL -->
<div id="PS" class="hidden">
  <div class="layout">
    <aside class="sidebar" id="sidebar">
      <div class="s-logo"><div class="lt">KIGHMU</div><div class="ls">Admin Panel</div></div>
      <nav class="s-nav">
        <div class="s-sec">Vue gÃ©nÃ©rale</div>
        <a class="nav active" data-p="dash" onclick="nav('dash')"><span class="ic">â—ˆ</span> Dashboard</a>
        <div class="s-sec">Tunnels</div>
        <a class="nav" data-p="create" onclick="nav('create')" style="border-left:2px solid rgba(0,200,255,.3)"><span class="ic" style="color:var(--cyan)">ï¼‹</span><span style="color:var(--cyan)">CrÃ©er un Tunnel</span></a>
        <a class="nav" data-p="clients" onclick="nav('clients');loadClients()"><span class="ic">â—Ž</span> Tous les Clients</a>
        <div class="s-sec">Revendeurs</div>
        <a class="nav" data-p="resellers" onclick="nav('resellers');loadResellers()"><span class="ic">â—‰</span> GÃ©rer Revendeurs</a>
        <div class="s-sec">SystÃ¨me</div>
        <a class="nav" data-p="system" onclick="nav('system');loadSystem()"><span class="ic">â—‡</span> Monitoring</a>
        <a class="nav" data-p="logs" onclick="nav('logs');loadLogs()"><span class="ic">â‰¡</span> Logs</a>
      </nav>
      <div class="s-foot">
        <div style="display:flex;align-items:center;gap:.4rem;margin-bottom:.3rem"><span class="dot dg"></span><span class="s-user" id="su">admin</span></div>
        <div class="muted sm mono" id="ltime"></div>
        <div style="margin-top:.65rem"><button class="btn btn-r btn-sm" onclick="logout()" style="width:100%;justify-content:center">âŠ— DÃ©connexion</button></div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="flex aic g1"><button class="mbtn" id="mbtn">â˜°</button><div class="tb-title" id="ptitle"><span>â¬¡</span> Dashboard</div></div>
        <div class="tb-acts">
          <span class="b bc" id="tu">ADMIN</span>
          <button class="btn btn-c btn-sm" onclick="nav('create')" style="letter-spacing:.04em">ï¼‹ CrÃ©er Tunnel</button>
          <button class="btn btn-gh btn-sm" onclick="refresh()">âŸ³</button>
        </div>
      </div>

      <!-- PAGE DASHBOARD -->
      <div class="page active" id="page-dash">
        <div class="ptitle">Dashboard</div>
        <div class="psub">Vue globale du systÃ¨me Kighmu</div>
        <div class="sgrid">
          <div class="scard c"><div class="scard-lbl">Revendeurs</div><div class="scard-val" id="s0">â€”</div><div class="scard-ico">â—‰</div></div>
          <div class="scard"><div class="scard-lbl">Total Clients</div><div class="scard-val" id="s1">â€”</div><div class="scard-ico">â—Ž</div></div>
          <div class="scard g"><div class="scard-lbl">Clients Actifs</div><div class="scard-val" id="s2">â€”</div><div class="scard-ico">âœ“</div></div>
          <div class="scard p"><div class="scard-lbl">Upload Total</div><div class="scard-val" id="s3">â€”</div><div class="scard-ico">â†‘</div></div>
          <div class="scard y"><div class="scard-lbl">Download Total</div><div class="scard-val" id="s4">â€”</div><div class="scard-ico">â†“</div></div>
        </div>
        <div class="card">
          <div class="ch"><div class="ct">â—‡ SystÃ¨me</div><button class="btn btn-gh btn-sm" onclick="loadDash()">âŸ³</button></div>
          <div class="cb"><div class="mgrid">
            <div class="mi"><div class="ml"><span class="mk">CPU</span><span class="mv" id="mc">â€”</span></div><div class="prg"><div class="prg-b" id="mcb" style="width:0%"></div></div></div>
            <div class="mi"><div class="ml"><span class="mk">RAM</span><span class="mv" id="mr">â€”</span></div><div class="prg"><div class="prg-b" id="mrb" style="width:0%"></div></div></div>
            <div class="mi"><div class="ml"><span class="mk">Disque</span><span class="mv" id="md">â€”</span></div><div class="prg"><div class="prg-b" id="mdb" style="width:0%"></div></div></div>
          </div></div>
        </div>
        <div class="card">
          <div class="ch"><div class="ct">â—‰ Revendeurs</div><div class="flex g1"><button class="btn btn-c btn-sm" onclick="openM('mar')">+ Ajouter</button><button class="btn btn-gh btn-sm" onclick="nav('resellers');loadResellers()">Voir tout</button></div></div>
          <div class="cb" style="padding:0"><div class="tw"><table><thead><tr><th>Revendeur</th><th>Clients</th><th>Quota</th><th>Data</th><th>Expire</th><th>Statut</th></tr></thead><tbody id="dr"><tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--muted)">Chargement...</td></tr></tbody></table></div></div>
        </div>
        <div class="card">
          <div class="ch"><div class="ct">â—Ž Derniers Clients</div><button class="btn btn-c btn-sm" onclick="nav('create')" style="background:linear-gradient(135deg,rgba(0,200,255,.15),rgba(124,58,237,.15))">ï¼‹ CrÃ©er Tunnel</button></div>
          <div class="cb" style="padding:0"><div class="tw"><table><thead><tr><th>Username</th><th>Tunnel</th><th>Revendeur</th><th>Expire</th><th>Statut</th></tr></thead><tbody id="dc"><tr><td colspan="5" style="text-align:center;padding:2rem;color:var(--muted)">Chargement...</td></tr></tbody></table></div></div>
        </div>
      </div>

      <!-- PAGE CRÃ‰ER TUNNEL -->
      <div class="page" id="page-create">
        <div class="ptitle">CrÃ©er un Tunnel</div>
        <div class="psub">Ajouter un utilisateur Xray (VLESS/VMESS/Trojan) Â· SSH Â· UDP Â· V2Ray FastDNS</div>
        <div class="card" style="max-width:800px">
          <div class="ch"><div class="ct">â¬¡ Nouveau Client Tunnel</div><span class="b bc">ADMIN</span></div>
          <div class="cb">
            <div class="ssep">1 â€” Type de tunnel</div>
            <div class="tgrid">
              <div class="tc2" data-t="vless" onclick="selT(this,'vless')"><div class="tci">â¬¡</div><div class="tlb">VLESS</div><div class="tsb">Xray</div></div>
              <div class="tc2" data-t="vmess" onclick="selT(this,'vmess')"><div class="tci">â¬¡</div><div class="tlb">VMESS</div><div class="tsb">Xray</div></div>
              <div class="tc2" data-t="trojan" onclick="selT(this,'trojan')"><div class="tci">â¬¡</div><div class="tlb">TROJAN</div><div class="tsb">Xray</div></div>
              <div class="tc2 ssh" data-t="ssh-ws" onclick="selT(this,'ssh-ws')"><div class="tci">âŒ˜</div><div class="tlb">SSH WS</div><div class="tsb">WebSocket</div></div>
              <div class="tc2 ssh" data-t="ssh-slowdns" onclick="selT(this,'ssh-slowdns')"><div class="tci">âŒ˜</div><div class="tlb">SSH SlowDNS</div><div class="tsb">DNS Tunnel</div></div>
              <div class="tc2 ssh" data-t="ssh-ssl" onclick="selT(this,'ssh-ssl')"><div class="tci">âŒ˜</div><div class="tlb">SSH SSL</div><div class="tsb">Stunnel</div></div>
              <div class="tc2 udp" data-t="udp-zivpn" onclick="selT(this,'udp-zivpn')"><div class="tci">â¬¢</div><div class="tlb">UDP ZIVPN</div><div class="tsb">Custom UDP</div></div>
              <div class="tc2 udp" data-t="udp-hysteria" onclick="selT(this,'udp-hysteria')"><div class="tci">â¬¢</div><div class="tlb">HYSTERIA</div><div class="tsb">UDP Custom</div></div>
              <div class="tc2 v2" data-t="v2ray-fastdns" onclick="selT(this,'v2ray-fastdns')"><div class="tci">â—ˆ</div><div class="tlb">V2Ray FastDNS</div><div class="tsb">FastDNS</div></div>
            </div>
            <div id="tsel" style="margin-bottom:.875rem;display:none"><span class="muted sm">SÃ©lectionnÃ© : </span><span id="tsv" class="b bc" style="font-size:.8rem"></span></div>
            <div class="ssep">2 â€” Informations</div>
            <div class="fgrid">
              <div class="fg"><label class="fl">Username *</label><input class="fc" id="cu" placeholder="ex: user_jean"></div>
              <div class="fg"><label class="fl">Mot de passe <span class="muted">(auto si vide)</span></label><div class="flex g1"><input class="fc" id="cp" placeholder="(auto-gÃ©nÃ©rÃ©)" style="flex:1"><button class="btn btn-gh btn-sm" onclick="genP()" title="GÃ©nÃ©rer">âŸ³</button></div></div>
              <div class="fg"><label class="fl">Expiration *</label><input class="fc" type="date" id="ce"></div>
              <div class="fg"><label class="fl">Revendeur <span class="muted">(optionnel)</span></label><select class="fc" id="cr"><option value="">â€” Aucun (admin) â€”</option></select></div>
              <div class="fg" style="grid-column:1/-1"><label class="fl">Note <span class="muted">(optionnel)</span></label><input class="fc" id="cn" placeholder="Ex: client VIP, abonnement mensuel..."></div>
            </div>
            <div class="flex g2 mt1" style="margin-top:1.25rem;flex-wrap:wrap">
              <button class="btn btn-c" id="csub" onclick="createT()" style="padding:.6rem 1.4rem"><span id="csubl">â¬¡ CrÃ©er le Tunnel</span></button>
              <button class="btn btn-gh" onclick="resetT()">âœ• RÃ©initialiser</button>
            </div>
          </div>
        </div>
        <div class="rescard hidden" id="cres">
          <div class="rh"><div class="rt">âœ“ Tunnel crÃ©Ã© avec succÃ¨s</div><button class="cpbtn" onclick="document.getElementById('cres').classList.add('hidden')">âœ•</button></div>
          <div class="rbody" id="cresbody"></div>
        </div>
        <div class="card" style="max-width:800px;margin-top:1.25rem">
          <div class="ch"><div class="ct">â—Ž CrÃ©Ã©s cette session</div></div>
          <div class="cb" style="padding:0"><div class="tw"><table><thead><tr><th>Username</th><th>Password</th><th>UUID</th><th>Tunnel</th><th>Expire</th></tr></thead><tbody id="sess"><tr><td colspan="5" style="text-align:center;padding:1.25rem;color:var(--muted)">Aucun tunnel crÃ©Ã© cette session</td></tr></tbody></table></div></div>
        </div>
      </div>

      <!-- PAGE CLIENTS -->
      <div class="page" id="page-clients">
        <div class="ptitle">Tous les Clients</div>
        <div class="psub">Vue complÃ¨te admin de tous les utilisateurs tunnel</div>
        <div class="ibanner">
          <div class="ibi"><div class="ibk">Total</div><div class="ibv" id="cl0">â€”</div></div>
          <div class="ibi"><div class="ibk">Actifs</div><div class="ibv" id="cl1" style="color:var(--green)">â€”</div></div>
          <div class="ibi"><div class="ibk">ExpirÃ©s</div><div class="ibv" id="cl2" style="color:var(--red)">â€”</div></div>
          <div class="ibi"><div class="ibk">Xray</div><div class="ibv" id="cl3">â€”</div></div>
          <div class="ibi"><div class="ibk">SSH</div><div class="ibv" id="cl4">â€”</div></div>
          <div class="ibi"><div class="ibk">UDP</div><div class="ibv" id="cl5">â€”</div></div>
        </div>
        <div class="card">
          <div class="ch">
            <div class="flex aic g1" style="flex-wrap:wrap;gap:.4rem">
              <div class="sbox"><input type="text" id="csrch" placeholder="Username, tunnel, revendeur..." oninput="filterC()"></div>
              <select class="fc" id="ctf" style="width:auto;font-size:.76rem;padding:.38rem .6rem" onchange="filterC()">
                <option value="">Tous tunnels</option>
                <option value="vless">VLESS</option><option value="vmess">VMESS</option><option value="trojan">Trojan</option>
                <option value="ssh-ws">SSH WS</option><option value="ssh-slowdns">SSH SlowDNS</option><option value="ssh-ssl">SSH SSL</option>
                <option value="udp-zivpn">UDP ZIVPN</option><option value="udp-hysteria">UDP Hysteria</option>
                <option value="v2ray-fastdns">V2Ray FastDNS</option>
              </select>
              <select class="fc" id="csf" style="width:auto;font-size:.76rem;padding:.38rem .6rem" onchange="filterC()">
                <option value="">Tous statuts</option><option value="a">Actifs</option><option value="e">ExpirÃ©s</option>
              </select>
            </div>
            <button class="btn btn-c btn-sm" onclick="nav('create')">ï¼‹ CrÃ©er</button>
          </div>
          <div class="cb" style="padding:0"><div class="tw"><table>
            <thead><tr><th>#</th><th>Username</th><th>Password</th><th>UUID</th><th>Tunnel</th><th>Revendeur</th><th>â†‘</th><th>â†“</th><th>Expire</th><th>Statut</th><th>Actions</th></tr></thead>
            <tbody id="ctbl"><tr><td colspan="11" style="text-align:center;padding:3rem;color:var(--muted)">Chargement...</td></tr></tbody>
          </table></div></div>
        </div>
      </div>

      <!-- PAGE REVENDEURS -->
      <div class="page" id="page-resellers">
        <div class="ptitle">Gestion Revendeurs</div>
        <div class="psub">CrÃ©er, modifier, supprimer les comptes revendeurs</div>
        <div class="card">
          <div class="ch"><div class="sbox"><input type="text" id="rsrch" placeholder="Rechercher..." oninput="filterR()"></div><button class="btn btn-c" onclick="openM('mar')">+ Nouveau Revendeur</button></div>
          <div class="cb" style="padding:0"><div class="tw"><table>
            <thead><tr><th>#</th><th>Username</th><th>Clients</th><th>Limite</th><th>Quota</th><th>Expire</th><th>Statut</th><th>Actions</th></tr></thead>
            <tbody id="rtbl"><tr><td colspan="8" style="text-align:center;padding:3rem;color:var(--muted)">Chargement...</td></tr></tbody>
          </table></div></div>
        </div>
      </div>

      <!-- PAGE MONITORING -->
      <div class="page" id="page-system">
        <div class="ptitle">Monitoring SystÃ¨me</div>
        <div class="psub">Ressources VPS en temps rÃ©el</div>
        <div class="sgrid">
          <div class="scard c"><div class="scard-lbl">CPU</div><div class="scard-val" id="sc">â€”</div></div>
          <div class="scard"><div class="scard-lbl">RAM Libre</div><div class="scard-val" id="srf">â€”</div></div>
          <div class="scard g"><div class="scard-lbl">RAM Total</div><div class="scard-val" id="srt">â€”</div></div>
          <div class="scard p"><div class="scard-lbl">Disque Libre</div><div class="scard-val" id="sdf">â€”</div></div>
        </div>
        <div class="card">
          <div class="ch"><div class="ct">Ressources dÃ©taillÃ©es</div><button class="btn btn-gh btn-sm" onclick="loadSystem()">âŸ³</button></div>
          <div class="cb"><div class="mgrid">
            <div class="mi"><div class="ml"><span class="mk">CPU</span><span class="mv" id="scv">â€”</span></div><div class="prg" style="height:12px"><div class="prg-b" id="scb" style="width:0%"></div></div></div>
            <div class="mi"><div class="ml"><span class="mk">RAM</span><span class="mv" id="srv">â€”</span></div><div class="prg" style="height:12px"><div class="prg-b" id="srb" style="width:0%"></div></div></div>
            <div class="mi"><div class="ml"><span class="mk">Disque</span><span class="mv" id="sdv">â€”</span></div><div class="prg" style="height:12px"><div class="prg-b" id="sdb" style="width:0%"></div></div></div>
          </div></div>
        </div>
      </div>

      <!-- PAGE LOGS -->
      <div class="page" id="page-logs">
        <div class="ptitle">Logs d'ActivitÃ©</div>
        <div class="psub">200 derniÃ¨res actions enregistrÃ©es</div>
        <div class="card">
          <div class="ch"><div class="ct">Journal SystÃ¨me</div><button class="btn btn-gh btn-sm" onclick="loadLogs()">âŸ³</button></div>
          <div class="cb" style="padding:0"><div class="tw"><table>
            <thead><tr><th>Date</th><th>Acteur</th><th>RÃ´le</th><th>Action</th><th>Cible</th><th>IP</th></tr></thead>
            <tbody id="ltbl"></tbody>
          </table></div></div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- MODAL: ADD RESELLER -->
<div class="mo" id="mar">
  <div class="modal">
    <div class="mh"><div class="mt">+ Nouveau Revendeur</div><button class="btn btn-gh btn-ic" onclick="closeM('mar')">âœ•</button></div>
    <div class="mb"><div class="fgrid">
      <div class="fg"><label class="fl">Username *</label><input class="fc" id="rnu" placeholder="revendeur1"></div>
      <div class="fg"><label class="fl">Mot de passe *</label><input class="fc" id="rnp" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"></div>
      <div class="fg"><label class="fl">Email</label><input class="fc" id="rne" type="email" placeholder="email@ex.com"></div>
      <div class="fg"><label class="fl">Max Users *</label><input class="fc" id="rnm" type="number" value="10" min="1"></div>
      <div class="fg"><label class="fl">Expire le *</label><input class="fc" id="rnx" type="date"></div>
    </div></div>
    <div class="mf"><button class="btn btn-gh" onclick="closeM('mar')">Annuler</button><button class="btn btn-c" onclick="addR()">CrÃ©er</button></div>
  </div>
</div>

<!-- MODAL: EDIT RESELLER -->
<div class="mo" id="mer">
  <div class="modal">
    <div class="mh"><div class="mt">âœŽ Modifier Revendeur</div><button class="btn btn-gh btn-ic" onclick="closeM('mer')">âœ•</button></div>
    <div class="mb">
      <input type="hidden" id="reid">
      <div class="fgrid">
        <div class="fg"><label class="fl">Max Users</label><input class="fc" id="rem" type="number" min="1"></div>
        <div class="fg"><label class="fl">Expire le</label><input class="fc" id="rex" type="date"></div>
        <div class="fg"><label class="fl">Statut</label><select class="fc" id="rea"><option value="1">Actif</option><option value="0">DÃ©sactivÃ©</option></select></div>
        <div class="fg"><label class="fl">Nouveau mot de passe</label><input class="fc" id="rep" type="password" placeholder="(inchangÃ© si vide)"></div>
      </div>
    </div>
    <div class="mf"><button class="btn btn-gh" onclick="closeM('mer')">Annuler</button><button class="btn btn-c" onclick="editR()">Enregistrer</button></div>
  </div>
</div>

<!-- MODAL: EDIT CLIENT -->
<div class="mo" id="mec">
  <div class="modal">
    <div class="mh"><div class="mt">âœŽ Modifier Client</div><button class="btn btn-gh btn-ic" onclick="closeM('mec')">âœ•</button></div>
    <div class="mb">
      <input type="hidden" id="ecid">
      <div class="fgrid">
        <div class="fg"><label class="fl">Username</label><input class="fc" id="ecu" disabled style="opacity:.5"></div>
        <div class="fg"><label class="fl">Tunnel</label><input class="fc" id="ect" disabled style="opacity:.5"></div>
        <div class="fg"><label class="fl">Expire le</label><input class="fc" type="date" id="ecx"></div>
        <div class="fg"><label class="fl">Statut</label><select class="fc" id="eca"><option value="1">Actif</option><option value="0">DÃ©sactivÃ©</option></select></div>
        <div class="fg" style="grid-column:1/-1"><label class="fl">Note</label><input class="fc" id="ecn"></div>
      </div>
    </div>
    <div class="mf"><button class="btn btn-gh" onclick="closeM('mec')">Annuler</button><button class="btn btn-c" onclick="saveC()">Enregistrer</button></div>
  </div>
</div>

<div class="tc" id="toastC"></div>

<script>
// ============================================================
// UTILITIES
// ============================================================
const API = {
  t: localStorage.getItem('kt'),
  h() { return { 'Content-Type':'application/json', Authorization:`Bearer ${this.t}` }; },
  async req(m, u, d) {
    const o = { method:m, headers:this.h() };
    if(d) o.body = JSON.stringify(d);
    const r = await fetch(u, o);
    const j = await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(j.error || `HTTP ${r.status}`);
    return j;
  },
  get: u => API.req('GET',u),
  post: (u,d) => API.req('POST',u,d),
  put: (u,d) => API.req('PUT',u,d),
  del: u => API.req('DELETE',u),
};

const fmtB = (b,d=2) => { if(!b||b==0) return '0 B'; const k=1024,s=['B','KB','MB','GB','TB'],i=Math.floor(Math.log(b)/Math.log(k)); return (b/Math.pow(k,i)).toFixed(d)+' '+s[i]; };
const fmtD = d => d ? new Date(d).toLocaleDateString('fr-FR') : '-';
const fmtDT = d => d ? new Date(d).toLocaleDateString('fr-FR')+' '+new Date(d).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}) : '-';
const isExp = d => new Date(d) < new Date();
const dLeft = d => Math.ceil((new Date(d)-new Date())/(1000*60*60*24));
const toDay = () => new Date().toISOString().split('T')[0];
const dInp = d => d ? new Date(d).toISOString().split('T')[0] : '';

const TC = {vless:'bc',vmess:'bp',trojan:'by','ssh-ws':'bg','ssh-slowdns':'bg','ssh-ssl':'bg','udp-zivpn':'br','udp-hysteria':'br','v2ray-fastdns':'bp'};
const tbadge = t => `<span class="b ${TC[t]||'bc'}">${t}</span>`;

const Toast = {
  show(msg, type='i', dur=3500) {
    const ic = {s:'âœ“',e:'âœ—',i:'â„¹'};
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.innerHTML = `<span>${ic[type]}</span>${msg}`;
    document.getElementById('toastC').appendChild(t);
    setTimeout(()=>t.remove(), dur);
  },
  s:m=>Toast.show(m,'s'), e:m=>Toast.show(m,'e'), i:m=>Toast.show(m,'i')
};

const openM  = id => document.getElementById(id)?.classList.add('open');
const closeM = id => document.getElementById(id)?.classList.remove('open');

let curPage = 'dash';
function nav(id) {
  curPage = id;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+id)?.classList.add('active');
  document.querySelector(`[data-p="${id}"]`)?.classList.add('active');
  const titles = {dash:'Dashboard',create:'CrÃ©er un Tunnel',clients:'Tous les Clients',resellers:'Revendeurs',system:'Monitoring',logs:'Logs'};
  document.getElementById('ptitle').innerHTML = `<span>â¬¡</span> ${titles[id]||id}`;
  document.getElementById('sidebar')?.classList.remove('open');
}

function refresh() {
  if(curPage==='dash') loadDash();
  else if(curPage==='clients') loadClients();
  else if(curPage==='resellers') loadResellers();
  else if(curPage==='system') loadSystem();
  else if(curPage==='logs') loadLogs();
}

function logout() { localStorage.clear(); location.href='/'; }

// ============================================================
// AUTH
// ============================================================
async function doLogin() {
  const u = document.getElementById('lu').value.trim();
  const p = document.getElementById('lp').value;
  const err = document.getElementById('lerr');
  err.style.display='none';
  if(!u||!p){err.textContent='Remplissez tous les champs.';err.style.display='block';return;}
  const btn = document.getElementById('lbtn');
  btn.innerHTML='<span class="spin"></span>';
  try {
    const d = await API.post('/api/auth/admin/login',{username:u,password:p});
    localStorage.setItem('kt',d.token);
    localStorage.setItem('kr',d.role);
    localStorage.setItem('ku',d.username);
    API.t = d.token;
    initPanel(d.username);
  } catch(e){err.textContent=e.message;err.style.display='block';}
  finally{btn.innerHTML='<span>SE CONNECTER</span>';}
}
document.addEventListener('keypress',e=>{if(e.key==='Enter'&&!document.getElementById('LS').classList.contains('hidden'))doLogin();});

function initPanel(uname) {
  document.getElementById('LS').classList.add('hidden');
  document.getElementById('PS').classList.remove('hidden');
  document.getElementById('su').textContent = uname||'admin';
  document.getElementById('tu').textContent = (uname||'ADMIN').toUpperCase();
  document.getElementById('ce').setAttribute('min',toDay());
  document.getElementById('rnx').setAttribute('min',toDay());
  setInterval(()=>{ const t=new Date(); document.getElementById('ltime').textContent=t.toLocaleTimeString('fr-FR'); },1000);
  loadDash(); loadROptions();
}

document.getElementById('mbtn')?.addEventListener('click',()=>document.getElementById('sidebar').classList.toggle('open'));
document.addEventListener('click',e=>{const s=document.getElementById('sidebar'); if(s&&!s.contains(e.target)&&e.target.id!=='mbtn') s.classList.remove('open');});

// VÃ©rification du token au chargement â€” Ã©vite le blocage sur token expirÃ©
(async function checkAuth() {
  const token = localStorage.getItem('kt');
  const role  = localStorage.getItem('kr');
  const uname = localStorage.getItem('ku');
  if (!token || role !== 'admin') return; // pas de token â†’ afficher login
  API.t = token;
  try {
    // VÃ©rifier que le token est encore valide cÃ´tÃ© serveur
    const r = await fetch('/api/admin/stats', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if (r.status === 401 || r.status === 403) {
      // Token invalide ou expirÃ© â†’ vider et afficher login
      localStorage.clear();
      return;
    }
    // Token valide â†’ afficher le panel
    initPanel(uname);
  } catch(e) {
    // Erreur rÃ©seau â†’ vider et afficher login
    localStorage.clear();
  }
})();

// ============================================================
// DASHBOARD
// ============================================================
async function loadDash() {
  try {
    const d = await API.get('/api/admin/stats');
    const g=d.global, sys=d.system;
    document.getElementById('s0').textContent=g.total_resellers;
    document.getElementById('s1').textContent=g.total_clients;
    document.getElementById('s2').textContent=g.active_clients;
    document.getElementById('s3').textContent=fmtB(g.total_upload);
    document.getElementById('s4').textContent=fmtB(g.total_download);
    const cpu=parseFloat(sys.cpu_usage), rPct=Math.round(sys.ram_used/sys.ram_total*100);
    const dPct=sys.disk?Math.round(sys.disk.used/sys.disk.total*100):0;
    document.getElementById('mc').textContent=cpu.toFixed(1)+'%'; document.getElementById('mcb').style.width=cpu+'%';
    document.getElementById('mr').textContent=fmtB(sys.ram_free)+' libre'; document.getElementById('mrb').style.width=rPct+'%';
    if(sys.disk){document.getElementById('md').textContent=fmtB(sys.disk.free)+' libre'; document.getElementById('mdb').style.width=dPct+'%';}
    document.getElementById('dr').innerHTML = d.resellers.length ? d.resellers.map(r=>{
      const ex=isExp(r.expires_at),dy=dLeft(r.expires_at),pct=r.max_users>0?Math.min(100,(r.used_users/r.max_users)*100).toFixed(0):0;
      return `<tr><td class="nm">${r.username}</td><td>${r.used_users}</td><td><div style="display:flex;align-items:center;gap:.4rem"><div class="prg" style="width:65px"><div class="prg-b" style="width:${pct}%"></div></div><span class="muted sm">${pct}%</span></div></td><td>${fmtB(parseInt(r.upload||0)+parseInt(r.download||0))}</td><td>${fmtD(r.expires_at)}${!ex&&dy<=7?` <span class="b by">${dy}j</span>`:''}</td><td>${ex?'<span class="b br">EXPIRÃ‰</span>':r.is_active?'<span class="b bg">ACTIF</span>':'<span class="b br">OFF</span>'}</td></tr>`;
    }).join('') : '<tr><td colspan="6" style="text-align:center;padding:1.5rem;color:var(--muted)">Aucun revendeur</td></tr>';
    const cl = await API.get('/api/admin/clients');
    document.getElementById('dc').innerHTML = cl.slice(0,6).map(c=>`<tr><td class="nm">${c.username}</td><td>${tbadge(c.tunnel_type)}</td><td>${c.reseller_name||'<span class="muted">admin</span>'}</td><td>${fmtD(c.expires_at)}${isExp(c.expires_at)?'<span class="b br" style="margin-left:.3rem">EXP</span>':''}</td><td>${c.is_active&&!isExp(c.expires_at)?'<span class="b bg">ACTIF</span>':'<span class="b br">INACTIF</span>'}</td></tr>`).join('')||'<tr><td colspan="5" style="text-align:center;padding:1.5rem;color:var(--muted)">Aucun client</td></tr>';
  } catch(e){Toast.e('Dashboard: '+e.message);}
}

// ============================================================
// CRÃ‰ER TUNNEL
// ============================================================
let selTunnel='';
const sessC=[];

function selT(el, t) {
  document.querySelectorAll('.tc2').forEach(c=>c.classList.remove('sel'));
  el.classList.add('sel'); selTunnel=t;
  document.getElementById('tsv').textContent=t.toUpperCase();
  document.getElementById('tsel').style.display='block';
}

function genP() {
  const c='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#!';
  let p=''; for(let i=0;i<12;i++) p+=c[Math.floor(Math.random()*c.length)];
  document.getElementById('cp').value=p;
}

async function createT() {
  const u=document.getElementById('cu').value.trim();
  const p=document.getElementById('cp').value.trim();
  const e=document.getElementById('ce').value;
  const n=document.getElementById('cn').value.trim();
  const r=document.getElementById('cr').value;
  if(!selTunnel) return Toast.e('SÃ©lectionnez un type de tunnel');
  if(!u) return Toast.e('Le username est obligatoire');
  if(!e) return Toast.e("La date d'expiration est obligatoire");
  const btn=document.getElementById('csub');
  btn.innerHTML='<span class="spin"></span> CrÃ©ation...'; btn.disabled=true;
  try {
    const res = await API.post('/api/admin/clients',{username:u,password:p||undefined,tunnel_type:selTunnel,expires_at:e,note:n||undefined,reseller_id:r?parseInt(r):null});
    const resEl=document.getElementById('cres');
    resEl.classList.remove('hidden');
    document.getElementById('cresbody').innerHTML=`
      <div class="rrow"><div class="rk">Username</div><div class="rv hi">${res.username}</div><button class="cpbtn" onclick="cp('${res.username}')">ðŸ“‹</button></div>
      <div class="rrow"><div class="rk">Password</div><div class="rv pw">${res.password}</div><button class="cpbtn" onclick="cp('${res.password}')">ðŸ“‹</button></div>
      <div class="rrow"><div class="rk">UUID</div><div class="rv uu">${res.uuid}</div><button class="cpbtn" onclick="cp('${res.uuid}')">ðŸ“‹</button></div>
      <div class="rrow"><div class="rk">Tunnel</div><div class="rv">${tbadge(res.tunnel_type)}</div></div>
      <div class="rrow"><div class="rk">Expire</div><div class="rv">${fmtD(res.expires_at)}</div></div>
      <div class="rrow"><div class="rk">Config</div><div class="rv" style="color:${res.tunnelResult?.ok===false?'var(--yellow)':'var(--green)'};font-size:.75rem">${res.tunnelResult?.ok===false?'âš  VÃ©rifiez les logs / service arrÃªtÃ©':'âœ“ InjectÃ© dans la configuration'}</div></div>`;
    sessC.unshift(res); renderSess();
    Toast.s(`Tunnel "${res.username}" crÃ©Ã© !`);
    resEl.scrollIntoView({behavior:'smooth',block:'nearest'});
    document.getElementById('cu').value=''; document.getElementById('cp').value=''; document.getElementById('cn').value='';
  } catch(e){Toast.e(e.message);}
  finally{btn.innerHTML='<span>â¬¡ CrÃ©er le Tunnel</span>'; btn.disabled=false;}
}

function renderSess() {
  const tb=document.getElementById('sess');
  if(!sessC.length){tb.innerHTML='<tr><td colspan="5" style="text-align:center;padding:1.25rem;color:var(--muted)">Aucun tunnel crÃ©Ã© cette session</td></tr>';return;}
  tb.innerHTML=sessC.map(r=>`<tr><td class="nm">${r.username}</td><td><code style="color:var(--yellow);font-size:.76rem">${r.password}</code> <button class="cpbtn" onclick="cp('${r.password}')">ðŸ“‹</button></td><td><code style="color:var(--dim);font-size:.7rem">${r.uuid?r.uuid.substring(0,18)+'â€¦':'â€”'}</code></td><td>${tbadge(r.tunnel_type)}</td><td>${fmtD(r.expires_at)}</td></tr>`).join('');
}

function resetT() {
  selTunnel=''; document.querySelectorAll('.tc2').forEach(c=>c.classList.remove('sel'));
  document.getElementById('tsel').style.display='none';
  ['cu','cp','ce','cn'].forEach(i=>document.getElementById(i).value='');
  document.getElementById('cr').value='';
  document.getElementById('cres').classList.add('hidden');
}

function cp(text) {
  navigator.clipboard.writeText(text).then(()=>Toast.s('CopiÃ© !')).catch(()=>{const ta=document.createElement('textarea');ta.value=text;document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();Toast.s('CopiÃ© !');});
}

async function loadROptions() {
  try {
    const rs=await API.get('/api/admin/resellers');
    const sel=document.getElementById('cr');
    while(sel.options.length>1) sel.remove(1);
    rs.forEach(r=>{const o=document.createElement('option');o.value=r.id;o.textContent=`${r.username} â€” ${r.used_users}/${r.max_users}`;sel.appendChild(o);});
  } catch{}
}

// ============================================================
// CLIENTS
// ============================================================
let allClients=[];

async function loadClients() {
  try {
    allClients=await API.get('/api/admin/clients');
    const a=allClients.filter(c=>c.is_active&&!isExp(c.expires_at)).length;
    const ex=allClients.filter(c=>isExp(c.expires_at)).length;
    document.getElementById('cl0').textContent=allClients.length;
    document.getElementById('cl1').textContent=a;
    document.getElementById('cl2').textContent=ex;
    document.getElementById('cl3').textContent=allClients.filter(c=>['vless','vmess','trojan'].includes(c.tunnel_type)).length;
    document.getElementById('cl4').textContent=allClients.filter(c=>c.tunnel_type.startsWith('ssh')).length;
    document.getElementById('cl5').textContent=allClients.filter(c=>c.tunnel_type.startsWith('udp')).length;
    renderClients(allClients);
  } catch(e){Toast.e(e.message);}
}

function renderClients(data) {
  const tb=document.getElementById('ctbl');
  if(!data.length){tb.innerHTML='<tr><td colspan="11" style="text-align:center;padding:3rem;color:var(--muted)">Aucun client</td></tr>';return;}
  tb.innerHTML=data.map(c=>{
    const ex=isExp(c.expires_at),dy=dLeft(c.expires_at);
    const st=!c.is_active?'<span class="b br">OFF</span>':ex?'<span class="b br">EXPIRÃ‰</span>':dy<=3?`<span class="b by">${dy}j</span>`:'<span class="b bg">ACTIF</span>';
    return `<tr>
      <td class="muted">${c.id}</td>
      <td class="nm">${c.username}</td>
      <td><code style="color:var(--yellow);font-size:.73rem">${c.password||'â€”'}</code></td>
      <td><code style="color:var(--dim);font-size:.7rem" title="${c.uuid||''}">${c.uuid?c.uuid.substring(0,12)+'â€¦':'â€”'}</code></td>
      <td>${tbadge(c.tunnel_type)}</td>
      <td>${c.reseller_name?`<span style="color:#a78bfa">${c.reseller_name}</span>`:'<span class="muted">admin</span>'}</td>
      <td>${fmtB(c.total_upload)}</td>
      <td>${fmtB(c.total_download)}</td>
      <td>${fmtD(c.expires_at)}</td>
      <td>${st}</td>
      <td><div class="actg">
        <button class="btn btn-c btn-sm btn-ic" onclick="openEC(${c.id},'${c.username}','${c.tunnel_type}','${dInp(c.expires_at)}',${c.is_active},'${(c.note||'').replace(/'/g,'`')}')">âœŽ</button>
        <button class="btn btn-r btn-sm btn-ic" onclick="delC(${c.id},'${c.username}')">âœ•</button>
      </div></td>
    </tr>`;
  }).join('');
}

function filterC() {
  const q=document.getElementById('csrch').value.toLowerCase();
  const t=document.getElementById('ctf').value;
  const s=document.getElementById('csf').value;
  renderClients(allClients.filter(c=>{
    const mq=!q||c.username.toLowerCase().includes(q)||c.tunnel_type.includes(q)||(c.reseller_name||'').toLowerCase().includes(q);
    const mt=!t||c.tunnel_type===t;
    const ms=!s||(s==='a'&&c.is_active&&!isExp(c.expires_at))||(s==='e'&&isExp(c.expires_at));
    return mq&&mt&&ms;
  }));
}

function openEC(id,u,t,x,a,n) {
  document.getElementById('ecid').value=id; document.getElementById('ecu').value=u;
  document.getElementById('ect').value=t;   document.getElementById('ecx').value=x;
  document.getElementById('eca').value=a;   document.getElementById('ecn').value=n||'';
  openM('mec');
}

async function saveC() {
  const id=document.getElementById('ecid').value;
  try {
    await API.put(`/api/admin/clients/${id}`,{expires_at:document.getElementById('ecx').value,is_active:parseInt(document.getElementById('eca').value),note:document.getElementById('ecn').value});
    Toast.s('Client mis Ã  jour'); closeM('mec'); loadClients();
  } catch(e){Toast.e(e.message);}
}

async function delC(id,u) {
  if(!confirm(`Supprimer "${u}" et rÃ©voquer ses accÃ¨s tunnel ?`)) return;
  try { await API.del(`/api/admin/clients/${id}`); Toast.s(`"${u}" supprimÃ©`); loadClients(); } catch(e){Toast.e(e.message);}
}

// ============================================================
// REVENDEURS
// ============================================================
let allRes=[];

async function loadResellers() {
  try { allRes=await API.get('/api/admin/resellers'); renderRes(allRes); } catch(e){Toast.e(e.message);}
}

function renderRes(data) {
  const tb=document.getElementById('rtbl');
  if(!data.length){tb.innerHTML='<tr><td colspan="8" style="text-align:center;padding:3rem;color:var(--muted)">Aucun revendeur</td></tr>';return;}
  tb.innerHTML=data.map(r=>{
    const ex=isExp(r.expires_at),dy=dLeft(r.expires_at),pct=r.max_users>0?Math.min(100,(r.used_users/r.max_users)*100).toFixed(0):0;
    return `<tr>
      <td class="muted">${r.id}</td><td class="nm">${r.username}</td>
      <td>${r.used_users}</td><td>${r.max_users}</td>
      <td><div style="display:flex;align-items:center;gap:.4rem"><div class="prg" style="width:65px"><div class="prg-b" style="width:${pct}%"></div></div><span class="muted sm">${pct}%</span></div></td>
      <td>${fmtD(r.expires_at)}${!ex&&dy<=7?` <span class="b by">${dy}j</span>`:''}</td>
      <td>${ex?'<span class="b br">EXPIRÃ‰</span>':r.is_active?'<span class="b bg">ACTIF</span>':'<span class="b br">OFF</span>'}</td>
      <td><div class="actg">
        <button class="btn btn-c btn-sm" onclick="openER(${r.id},${r.max_users},'${dInp(r.expires_at)}',${r.is_active})">âœŽ</button>
        <button class="btn btn-gh btn-sm" onclick="cleanR(${r.id},'${r.username}')" title="Supprimer tous ses clients">ðŸ—‘</button>
        <button class="btn btn-r btn-sm" onclick="delR(${r.id},'${r.username}')">âœ•</button>
      </div></td>
    </tr>`;
  }).join('');
}

function filterR() {
  const q=document.getElementById('rsrch').value.toLowerCase();
  renderRes(allRes.filter(r=>r.username.toLowerCase().includes(q)));
}

async function addR() {
  const d={username:document.getElementById('rnu').value.trim(),password:document.getElementById('rnp').value,email:document.getElementById('rne').value.trim()||undefined,max_users:parseInt(document.getElementById('rnm').value),expires_at:document.getElementById('rnx').value};
  if(!d.username||!d.password||!d.expires_at) return Toast.e('Champs requis manquants');
  try { await API.post('/api/admin/resellers',d); Toast.s(`Revendeur "${d.username}" crÃ©Ã©`); closeM('mar'); loadResellers(); loadROptions(); } catch(e){Toast.e(e.message);}
}

function openER(id,m,x,a){document.getElementById('reid').value=id;document.getElementById('rem').value=m;document.getElementById('rex').value=x;document.getElementById('rea').value=a;document.getElementById('rep').value='';openM('mer');}

async function editR() {
  const id=document.getElementById('reid').value;
  const d={max_users:parseInt(document.getElementById('rem').value),expires_at:document.getElementById('rex').value,is_active:parseInt(document.getElementById('rea').value)};
  const pw=document.getElementById('rep').value; if(pw) d.password=pw;
  try { await API.put(`/api/admin/resellers/${id}`,d); Toast.s('Revendeur mis Ã  jour'); closeM('mer'); loadResellers(); } catch(e){Toast.e(e.message);}
}

async function cleanR(id,u) {
  if(!confirm(`âš ï¸ Supprimer TOUS les clients de "${u}" ?\nLeurs accÃ¨s tunnel seront rÃ©voquÃ©s.`)) return;
  try { await API.post(`/api/admin/resellers/${id}/clean`,{}); Toast.s('DonnÃ©es nettoyÃ©es'); loadResellers(); } catch(e){Toast.e(e.message);}
}

async function delR(id,u) {
  if(!confirm(`âš ï¸ SUPPRIMER "${u}" et tous ses clients ? IrrÃ©versible !`)) return;
  try { await API.del(`/api/admin/resellers/${id}`); Toast.s(`"${u}" supprimÃ©`); loadResellers(); } catch(e){Toast.e(e.message);}
}

// ============================================================
// SYSTÃˆME
// ============================================================
async function loadSystem() {
  try {
    const d=await API.get('/api/admin/stats'); const sys=d.system;
    const cpu=parseFloat(sys.cpu_usage),rP=Math.round(sys.ram_used/sys.ram_total*100),dP=sys.disk?Math.round(sys.disk.used/sys.disk.total*100):0;
    document.getElementById('sc').textContent=cpu.toFixed(1)+'%';
    document.getElementById('srf').textContent=fmtB(sys.ram_free);
    document.getElementById('srt').textContent=fmtB(sys.ram_total);
    document.getElementById('sdf').textContent=sys.disk?fmtB(sys.disk.free):'N/A';
    document.getElementById('scv').textContent=cpu.toFixed(1)+'%'; document.getElementById('scb').style.width=cpu+'%';
    document.getElementById('srv').textContent=`${fmtB(sys.ram_used)}/${fmtB(sys.ram_total)} (${rP}%)`; document.getElementById('srb').style.width=rP+'%';
    if(sys.disk){document.getElementById('sdv').textContent=`${fmtB(sys.disk.used)}/${fmtB(sys.disk.total)} (${dP}%)`; document.getElementById('sdb').style.width=dP+'%';}
  } catch(e){Toast.e(e.message);}
}

// ============================================================
// LOGS
// ============================================================
async function loadLogs() {
  try {
    const logs=await API.get('/api/admin/logs');
    const ac={DELETE:'var(--red)',CREATE:'var(--green)',LOGIN:'var(--cyan)',UPDATE:'var(--yellow)'};
    document.getElementById('ltbl').innerHTML=logs.map(l=>{
      const c=Object.entries(ac).find(([k])=>l.action.includes(k))?.[1]||'var(--dim)';
      return `<tr><td style="font-size:.73rem">${fmtDT(l.created_at)}</td><td class="nm">${l.actor_id}</td><td><span class="b ${l.actor_type==='admin'?'bc':'bp'}">${l.actor_type}</span></td><td><span style="color:${c};font-family:var(--mono);font-size:.76rem">${l.action}</span></td><td class="muted" style="font-size:.73rem">${l.target_type||'â€”'}${l.target_id?' #'+l.target_id:''}</td><td class="muted mono" style="font-size:.73rem">${l.ip_address||'â€”'}</td></tr>`;
    }).join('')||'<tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--muted)">Aucun log</td></tr>';
  } catch(e){Toast.e(e.message);}
}

// Auto-refresh
setInterval(()=>{if(curPage==='dash')loadDash();if(curPage==='system')loadSystem();},30000);
</script>
</body>
</html>
